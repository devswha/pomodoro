"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[525],{5525:function(e,t,r){r.d(t,{RealtimeProvider:function(){return d},r:function(){return c}});var n=r(5583),s=r(1780),i=r(7437),a=r(2265),o=r(1968),l=r(419);let u=(0,a.createContext)(),c=()=>{let e=(0,a.useContext)(u);if(!e)throw Error("useRealtime must be used within a RealtimeProvider");return e},d=e=>{var t,r;let{children:c}=e,{currentUser:d}=(0,l.a)(),[f,h]=(0,a.useState)(!1),[m,g]=(0,a.useState)("disconnected"),[S,w]=(0,a.useState)(new Map),[p,b]=(0,a.useState)({}),[v,E]=(0,a.useState)([]),[_,y]=(0,a.useState)([]),[k,I]=(0,a.useState)(null===(r=null===(t=navigator)||void 0===t?void 0:t.onLine)||void 0===r||r),[T,U]=(0,a.useState)(null),[O,P]=(0,a.useState)(null),[C,D]=(0,a.useState)([]),[R,M]=(0,a.useState)([]),[A,N]=(0,a.useState)([]),[j,L]=(0,a.useState)([]),[V,Q]=(0,a.useState)([]),x=(0,a.useRef)(),q=(0,a.useRef)(),B=(0,a.useRef)(new Map),J=(0,a.useRef)(Date.now()),z=(0,a.useRef)(new Map),G=(0,a.useCallback)(async()=>{if(d&&"connected"!==m){g("connecting");try{await X(),await Z(),await F(),h(!0),g("connected"),K(),_.length>0&&await es()}catch(e){console.error("Real-time connection failed:",e),g("disconnected"),W()}}},[d,m]),Y=(0,a.useCallback)(()=>{g("disconnected"),h(!1),B.current.forEach(e=>{e.unsubscribe()}),B.current.clear(),w(new Map),q.current&&clearInterval(q.current),x.current&&clearTimeout(x.current),b({}),E([])},[]),W=(0,a.useCallback)(()=>{x.current&&clearTimeout(x.current);let e=Math.min(1e3*Math.pow(2,"reconnecting"===m?1:0),3e4);x.current=setTimeout(()=>{g("reconnecting"),G()},e)},[G,m]),K=(0,a.useCallback)(()=>{q.current&&clearInterval(q.current),q.current=setInterval(async()=>{try{let{error:e}=await o.OQ.from(o.ji.USERS).select("id").eq("id",null==d?void 0:d.id).limit(1);if(e)throw e}catch(e){console.warn("Heartbeat failed:",e),f&&(g("reconnecting"),W())}},3e4)},[d,f,W]),X=(0,a.useCallback)(async()=>{if(!d)return;let e=o.OQ.channel("presence-user-".concat(d.id),{config:{presence:{key:d.id}}});e.on("presence",{event:"sync"},()=>{let t=e.presenceState();E(Object.keys(t).map(e=>{let[r]=t[e];return r}))}).on("presence",{event:"join"},e=>{let{key:t,newPresences:r}=e;console.log("User joined:",t,r)}).on("presence",{event:"leave"},e=>{let{key:t,leftPresences:r}=e;console.log("User left:",t,r)}),await e.subscribe(async t=>{"SUBSCRIBED"===t&&await e.track({user_id:d.id,username:d.displayName||d.id,status:"online",last_seen:new Date().toISOString(),active_session:(null==T?void 0:T.id)||null})}),B.current.set("presence",e),w(t=>new Map(t.set("presence",e)))},[d,T]),Z=(0,a.useCallback)(async()=>{if(!d)return;let e=o.OQ.channel("user-sessions-".concat(d.id)).on("postgres_changes",{event:"*",schema:"public",table:o.ji.POMODORO_SESSIONS,filter:"user_id=eq.".concat(d.id)},e=>{H(e)}).subscribe(),t=o.OQ.channel("user-stats-".concat(d.id)).on("postgres_changes",{event:"UPDATE",schema:"public",table:o.ji.USER_STATS,filter:"user_id=eq.".concat(d.id)},e=>{P(e.new)}).subscribe(),r=o.OQ.channel("user-meetings-".concat(d.id)).on("postgres_changes",{event:"*",schema:"public",table:o.ji.MEETINGS,filter:"user_id=eq.".concat(d.id)},e=>{$(e)}).subscribe();B.current.set("sessions",e),B.current.set("stats",t),B.current.set("meetings",r),w(n=>new Map([...n,["sessions",e],["stats",t],["meetings",r]]))},[d]),F=(0,a.useCallback)(async()=>{if(!d)return;let e=o.OQ.channel("global-leaderboard").on("postgres_changes",{event:"UPDATE",schema:"public",table:o.ji.USER_STATS},e=>{ee(e)}).subscribe(),t=o.OQ.channel("shared-sessions").on("postgres_changes",{event:"*",schema:"public",table:o.ji.POMODORO_SESSIONS,filter:"shared=eq.true"},e=>{et(e)}).subscribe();B.current.set("leaderboard",e),B.current.set("shared",t),w(r=>new Map([...r,["leaderboard",e],["shared",t]]))},[d]),H=(0,a.useCallback)(e=>{let{eventType:t,new:r,old:n}=e;switch(t){case"INSERT":"active"===r.status&&(U(r),ea({type:"session_started",message:'Pomodoro session "'.concat(r.title,'" started'),session:r,timestamp:new Date().toISOString()}));break;case"UPDATE":r.user_id===(null==d?void 0:d.id)&&er(r,n)&&U("active"===r.status?r:null);break;case"DELETE":n.user_id===(null==d?void 0:d.id)&&"active"===n.status&&U(null)}},[d]),$=(0,a.useCallback)(e=>{let{eventType:t,new:r,old:n}=e;if(D(e=>{switch(t){case"INSERT":return[...e,r];case"UPDATE":return e.map(e=>e.id===r.id?r:e);case"DELETE":return e.filter(e=>e.id!==n.id);default:return e}}),"INSERT"===t){let e=new Date(new Date("".concat(r.date,"T").concat(r.time)).getTime()-6e4*(r.reminder_minutes||15));e>new Date&&setTimeout(()=>{ea({type:"meeting_reminder",message:'Meeting "'.concat(r.title,'" starting in ').concat(r.reminder_minutes||15," minutes"),meeting:r,timestamp:new Date().toISOString()})},e.getTime()-Date.now())}},[]),ee=(0,a.useCallback)(e=>{L(t=>t.map(t=>t.user_id===e.new.user_id?(0,n._)({},t,e.new):t).sort((e,t)=>t.completed_minutes-e.completed_minutes))},[]),et=(0,a.useCallback)(e=>{let{eventType:t,new:r,old:n}=e;N(e=>{switch(t){case"INSERT":return[...e,r];case"UPDATE":return e.map(e=>e.id===r.id?r:e);case"DELETE":return e.filter(e=>e.id!==n.id);default:return e}})},[]),er=(0,a.useCallback)((e,t)=>{let r="session_".concat(e.id),n=z.current.get(r)||0;return Date.now()-n>5e3?(z.current.set(r,Date.now()),!0):new Date(e.updated_at)>=new Date(t.updated_at)},[]),en=(0,a.useCallback)(e=>{y(t=>[...t,(0,s._)((0,n._)({},e),{id:"sync_".concat(Date.now(),"_").concat(Math.random()),timestamp:Date.now(),retries:0})])},[]),es=(0,a.useCallback)(async()=>{if(!k||0===_.length)return;let e=[..._];y([]);let t=[];for(let r of e)try{await ei(r)}catch(e){console.error("Sync operation failed:",e,r),r.retries<3&&t.push((0,s._)((0,n._)({},r),{retries:r.retries+1}))}t.length>0&&y(e=>[...e,...t])},[k,_]),ei=(0,a.useCallback)(async e=>{let{type:t,table:r,data:n,id:s}=e;switch(t){case"INSERT":let{error:i}=await o.OQ.from(r).insert(n);if(i)throw i;break;case"UPDATE":let{error:a}=await o.OQ.from(r).update(n).eq("id",s);if(a)throw a;break;case"DELETE":let{error:l}=await o.OQ.from(r).delete().eq("id",s);if(l)throw l}},[]),ea=(0,a.useCallback)(e=>{M(t=>[(0,s._)((0,n._)({},e),{id:"notif_".concat(Date.now(),"_").concat(Math.random()),read:!1}),...t.slice(0,49)])},[]),eo=(0,a.useCallback)(e=>{M(t=>t.map(t=>t.id===e?(0,s._)((0,n._)({},t),{read:!0}):t))},[]),el=(0,a.useCallback)(()=>{M([])},[]),eu=(0,a.useCallback)(async e=>{let t=B.current.get("presence");t&&await t.track((0,s._)((0,n._)({},p,e),{last_seen:new Date().toISOString()}))},[p]),ec=(0,a.useCallback)(async(e,t,r)=>{let n=B.current.get(e);n&&await n.send({type:"broadcast",event:t,payload:r})},[]),ed=(0,a.useCallback)(async(e,t)=>{switch(e.table){case o.ji.POMODORO_SESSIONS:"UPDATE"===e.type&&"active"===t.status&&U(t);break;case o.ji.USER_STATS:"UPDATE"===e.type&&P(e=>(0,n._)({},e,t))}if(k&&f)try{await ei(e)}catch(t){console.error("Optimistic update failed, rolling back:",t),en(e)}else en(e)},[k,f,en,ei]);(0,a.useEffect)(()=>{let e=()=>{I(!0),d&&G()},t=()=>{I(!1),g("disconnected")};return window.addEventListener("online",e),window.addEventListener("offline",t),()=>{window.removeEventListener("online",e),window.removeEventListener("offline",t)}},[d,G]),(0,a.useEffect)(()=>{d&&k&&"disconnected"===m?G():d||"disconnected"===m||Y()},[d,k,m,G,Y]),(0,a.useEffect)(()=>()=>{Y()},[Y]),(0,a.useEffect)(()=>{let e=setInterval(async()=>{f&&d&&(Date.now()-J.current>3e5||_.length>0)&&(await es(),J.current=Date.now())},6e4);return()=>clearInterval(e)},[f,d,_,es]);let ef={isConnected:f,connectionStatus:m,isOnline:k,realtimeSession:T,realtimeStats:O,realtimeMeetings:C,notifications:R,presenceData:p,onlineUsers:v,updatePresence:eu,sharedSessions:A,leaderboard:j,activityFeed:V,syncQueue:_,optimisticUpdate:ed,addToSyncQueue:en,addNotification:ea,markNotificationAsRead:eo,clearNotifications:el,connect:G,disconnect:Y,broadcastMessage:ec,subscriptions:Array.from(S.keys())};return(0,i.jsx)(u.Provider,{value:ef,children:c})}},419:function(e,t,r){r.d(t,{UserProvider:function(){return c},a:function(){return u}});var n=r(5583),s=r(1780),i=r(7437),a=r(2265),o=r(81);let l=(0,a.createContext)(),u=()=>{let e=(0,a.useContext)(l);if(!e)throw Error("useUser must be used within a UserProvider");return e},c=e=>{let{children:t}=e,[r,u]=(0,a.useState)(null),[c]=(0,a.useState)(()=>new o.w),[d,f]=(0,a.useState)(null),[h,m]=(0,a.useState)(null),[g,S]=(0,a.useState)(!1),[w,p]=(0,a.useState)(!0),[b,v]=(0,a.useState)(null);(0,a.useEffect)(()=>{(async()=>{try{let e=c.getCurrentSession();if(e){let t=c.getUser(e.userId);t?(u(t),m(e.token),S(!0),k(e.userId)):c.logoutSession()}}catch(e){console.error("Error initializing auth:",e),c.logoutSession()}finally{p(!1)}})();let e=setInterval(()=>{if(h){let e=c.validateSession(h);if(e){let t=new Date(e.expiresAt),r=new Date,n=t.getTime()-r.getTime();n>0&&n<=3e5&&!e.rememberMe?v("세션이 ".concat(Math.ceil(n/6e4),"분 후 만료됩니다.")):v(null)}else v("세션이 만료되어 자동으로 로그아웃됩니다."),setTimeout(()=>y(),3e3)}},3e4);return()=>clearInterval(e)},[c,h]);let E=async function(e,t){let r=arguments.length>2&&void 0!==arguments[2]&&arguments[2];try{if(p(!0),v(null),!(null==e?void 0:e.trim()))throw Error("사용자명을 입력해주세요.");if(!t)throw Error("비밀번호를 입력해주세요.");let n=await c.loginUser(e.trim(),t,r);return u(n.user),m(n.sessionToken),S(!0),k(n.user.id),n.user}catch(e){if(console.error("Login failed:",e),e.message.includes("존재하지 않는"))throw Error("존재하지 않는 사용자입니다. 사용자명을 확인해주세요.");if(e.message.includes("비밀번호가 올바르지"))throw e;if(e.message.includes("일시적으로 잠겼습니다"))throw e;throw Error("로그인에 실패했습니다. 사용자명과 비밀번호를 확인해주세요.")}finally{p(!1)}},_=async(e,t)=>{try{var r;if(p(!0),v(null),!(null==e?void 0:e.trim()))throw Error("사용자명을 입력해주세요.");if(!(null==t?void 0:null===(r=t.email)||void 0===r?void 0:r.trim()))throw Error("이메일을 입력해주세요.");if(!(null==t?void 0:t.password))throw Error("비밀번호를 입력해주세요.");return await c.registerUser(e.trim(),(0,s._)((0,n._)({},t),{email:t.email.trim()}))}catch(e){if(console.error("Registration failed:",e),e.message.includes("이미 존재하는"))throw Error("이미 사용 중인 사용자명입니다. 다른 사용자명을 선택해주세요.");if(e.message.includes("이미 사용 중인 이메일"))throw Error("이미 사용 중인 이메일 주소입니다. 다른 이메일을 사용해주세요.");if(e.message.includes("비밀번호"))throw e;if(e.message.includes("이메일"))throw e;else if(e.message.includes("사용자명"))throw e;else throw Error("회원가입에 실패했습니다. 입력 정보를 확인하고 다시 시도해주세요.")}finally{p(!1)}},y=()=>{try{c.logoutSession(h),u(null),f(null),m(null),S(!1),v(null)}catch(e){console.error("Logout error:",e),u(null),f(null),m(null),S(!1),v(null)}},k=e=>{let t=c.getActiveSession(e);t&&(new Date<new Date(t.endTime)?f(t):(c.clearActiveSession(e),f(null)))},I=async e=>{if(!r)throw Error("No user logged in");try{let t=await c.updateUserProfile(r.id,e);return u(t),t}catch(e){throw console.error("Profile update failed:",e),e}};return(0,i.jsx)(l.Provider,{value:{currentUser:r,activeSession:d,sessionToken:h,isSessionValid:g,authLoading:w,sessionWarning:b,loginUser:E,registerUser:_,logoutUser:y,createPomodoroSession:e=>{if(!r)throw Error("No user logged in");let t=c.createPomodoroSession(r.id,e);return f(t),t},completePomodoroSession:()=>{r&&d&&(c.completePomodoroSession(r.id,d.id),f(null))},stopPomodoroSession:()=>{r&&d&&(c.stopPomodoroSession(r.id,d.id),f(null))},getUserStats:()=>r?c.getUserStats(r.id):null,getUserSessions:()=>r?c.getUserSessions(r.id):[],updateUserProfile:I,getUserActivity:function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:30;return r?c.getUserActivity(r.id,e):null},validateCurrentSession:()=>!!h&&(!!c.validateSession(h)||(y(),!1)),checkPasswordStrength:e=>{if(!e)return{isValid:!1,errors:["비밀번호를 입력해주세요"],warnings:[],score:0,strength:"weak"};let t=[];e.length<4&&t.push("비밀번호는 4자 이상이어야 합니다");let r=Math.min(10*e.length,100),n={medium:r>=50&&r<80,strong:r>=80};return{isValid:0===t.length,errors:t,warnings:[],score:r,strength:n.strong?"strong":n.medium?"medium":"weak"}},validateEmail:e=>{if(!e||"string"!=typeof e)return{isValid:!1,error:"이메일을 입력해주세요."};let t=e.trim().toLowerCase();return t.includes("@")?{isValid:!0,normalizedEmail:t}:{isValid:!1,error:"이메일에 @가 포함되어야 합니다."}},validateUsername:e=>{if(!e||"string"!=typeof e)return{isValid:!1,error:"사용자명을 입력해주세요."};let t=e.trim();return t.length<1?{isValid:!1,error:"사용자명을 입력해주세요."}:t.length>50?{isValid:!1,error:"사용자명은 50자 이하여야 합니다."}:{isValid:!0,normalizedUsername:t.toLowerCase()}},extendSession:()=>!!(h&&c.validateSession(h))&&(v(null),!0),dismissSessionWarning:()=>{v(null)},userManager:c},children:t})}},1968:function(e,t,r){r.d(t,{OQ:function(){return d},ji:function(){return f}});var n=r(8439),s=r(257);let i="https://demo.supabase.co",a="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRlbW8iLCJyb2xlIjoiYW5vbiIsImlhdCI6MTY0NjkyODAwMCwiZXhwIjoxOTYyNTA0MDAwfQ.demo-key-for-local-development",o=s.env.SUPABASE_SERVICE_ROLE_KEY,l=e=>{if(!e||e.includes("your_supabase")||e.includes("placeholder")||e.includes("demo.supabase.co"))return!1;try{return new URL(e),e.includes("supabase.co")}catch(e){return!1}},u=l(i)&&a&&!a.includes("your_");console.log("Supabase Configuration Status:",{url:i?"Present":"Missing",urlValid:l(i),anonKey:a?"Present":"Missing",anonKeyValid:a&&!a.includes("your_"),hasValidConfig:u});let c=()=>{let e={select:function(){return this},insert:function(){return this},update:function(){return this},delete:function(){return this},eq:function(){return this},neq:function(){return this},gt:function(){return this},gte:function(){return this},lt:function(){return this},lte:function(){return this},like:function(){return this},ilike:function(){return this},is:function(){return this},in:function(){return this},contains:function(){return this},containedBy:function(){return this},rangeGt:function(){return this},rangeGte:function(){return this},rangeLt:function(){return this},rangeLte:function(){return this},rangeAdjacent:function(){return this},overlaps:function(){return this},textSearch:function(){return this},match:function(){return this},not:function(){return this},or:function(){return this},filter:function(){return this},order:function(){return this},limit:function(){return this},range:function(){return this},abortSignal:function(){return this},single:function(){return Promise.resolve({data:null,error:{message:"Using localStorage mode - no data available"}})},maybeSingle:function(){return Promise.resolve({data:null,error:null})},then:function(e){return e({data:[],error:null})},catch:function(){return this}};return{from:()=>e,auth:{signUp:()=>Promise.resolve({data:{user:null,session:null},error:{message:"Using localStorage mode"}}),signInWithPassword:()=>Promise.resolve({data:{user:null,session:null},error:{message:"Using localStorage mode"}}),signOut:()=>Promise.resolve({error:null}),getUser:()=>Promise.resolve({data:{user:null},error:{message:"Using localStorage mode"}}),getSession:()=>Promise.resolve({data:{session:null},error:null}),onAuthStateChange:()=>({data:{subscription:{unsubscribe:()=>{}}}})},channel:()=>({on:function(){return this},subscribe:()=>Promise.resolve("SUBSCRIBED"),unsubscribe:()=>{},track:()=>Promise.resolve(),send:()=>Promise.resolve(),presenceState:()=>({})}),realtime:{disconnect:()=>{}}}},d=u?(0,n.eI)(i,a,{auth:{autoRefreshToken:!0,persistSession:!0,detectSessionInUrl:!0,storage:window.localStorage},realtime:{params:{eventsPerSecond:10}}}):c();u&&o?(0,n.eI)(i,o,{auth:{autoRefreshToken:!1,persistSession:!1}}):c();let f={USERS:"users",USER_PREFERENCES:"user_preferences",USER_STATS:"user_stats",POMODORO_SESSIONS:"pomodoro_sessions",MEETINGS:"meetings",AUTH_SESSIONS:"auth_sessions"}}}]);