"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[525],{5525:function(e,t,a){a.d(t,{RealtimeProvider:function(){return d},r:function(){return o}});var n=a(5583),s=a(1780),r=a(7437),c=a(2265),i=a(1968),l=a(419);let u=(0,c.createContext)(),o=()=>{let e=(0,c.useContext)(u);if(!e)throw Error("useRealtime must be used within a RealtimeProvider");return e},d=e=>{var t,a;let{children:o}=e,{currentUser:d}=(0,l.a)(),[w,b]=(0,c.useState)(!1),[m,f]=(0,c.useState)("disconnected"),[S,p]=(0,c.useState)(new Map),[_,h]=(0,c.useState)({}),[E,g]=(0,c.useState)([]),[v,k]=(0,c.useState)([]),[D,O]=(0,c.useState)(null===(a=null===(t=navigator)||void 0===t?void 0:t.onLine)||void 0===a||a),[T,y]=(0,c.useState)(null),[C,R]=(0,c.useState)(null),[I,M]=(0,c.useState)([]),[P,U]=(0,c.useState)([]),[j,A]=(0,c.useState)([]),[N,Q]=(0,c.useState)([]),[L,q]=(0,c.useState)([]),x=(0,c.useRef)(),B=(0,c.useRef)(),G=(0,c.useRef)(new Map),H=(0,c.useRef)(Date.now()),z=(0,c.useRef)(new Map),F=(0,c.useCallback)(async()=>{if(d&&"connected"!==m){f("connecting");try{await W(),await X(),await Y(),b(!0),f("connected"),V(),v.length>0&&await es()}catch(e){console.error("Real-time connection failed:",e),f("disconnected"),K()}}},[d,m]),J=(0,c.useCallback)(()=>{f("disconnected"),b(!1),G.current.forEach(e=>{e.unsubscribe()}),G.current.clear(),p(new Map),B.current&&clearInterval(B.current),x.current&&clearTimeout(x.current),h({}),g([])},[]),K=(0,c.useCallback)(()=>{x.current&&clearTimeout(x.current);let e=Math.min(1e3*Math.pow(2,"reconnecting"===m?1:0),3e4);x.current=setTimeout(()=>{f("reconnecting"),F()},e)},[F,m]),V=(0,c.useCallback)(()=>{B.current&&clearInterval(B.current),B.current=setInterval(async()=>{try{let{error:e}=await i.OQ.from(i.ji.USERS).select("id").eq("id",null==d?void 0:d.id).limit(1);if(e)throw e}catch(e){console.warn("Heartbeat failed:",e),w&&(f("reconnecting"),K())}},3e4)},[d,w,K]),W=(0,c.useCallback)(async()=>{if(!d)return;let e=i.OQ.channel("presence-user-".concat(d.id),{config:{presence:{key:d.id}}});e.on("presence",{event:"sync"},()=>{let t=e.presenceState();g(Object.keys(t).map(e=>{let[a]=t[e];return a}))}).on("presence",{event:"join"},e=>{let{key:t,newPresences:a}=e;console.log("User joined:",t,a)}).on("presence",{event:"leave"},e=>{let{key:t,leftPresences:a}=e;console.log("User left:",t,a)}),await e.subscribe(async t=>{"SUBSCRIBED"===t&&await e.track({user_id:d.id,username:d.displayName||d.id,status:"online",last_seen:new Date().toISOString(),active_session:(null==T?void 0:T.id)||null})}),G.current.set("presence",e),p(t=>new Map(t.set("presence",e)))},[d,T]),X=(0,c.useCallback)(async()=>{if(!d)return;let e=i.OQ.channel("user-sessions-".concat(d.id)).on("postgres_changes",{event:"*",schema:"public",table:i.ji.POMODORO_SESSIONS,filter:"user_id=eq.".concat(d.id)},e=>{Z(e)}).subscribe(),t=i.OQ.channel("user-stats-".concat(d.id)).on("postgres_changes",{event:"UPDATE",schema:"public",table:i.ji.USER_STATS,filter:"user_id=eq.".concat(d.id)},e=>{R(e.new)}).subscribe(),a=i.OQ.channel("user-meetings-".concat(d.id)).on("postgres_changes",{event:"*",schema:"public",table:i.ji.MEETINGS,filter:"user_id=eq.".concat(d.id)},e=>{$(e)}).subscribe();G.current.set("sessions",e),G.current.set("stats",t),G.current.set("meetings",a),p(n=>new Map([...n,["sessions",e],["stats",t],["meetings",a]]))},[d]),Y=(0,c.useCallback)(async()=>{if(!d)return;let e=i.OQ.channel("global-leaderboard").on("postgres_changes",{event:"UPDATE",schema:"public",table:i.ji.USER_STATS},e=>{ee(e)}).subscribe(),t=i.OQ.channel("shared-sessions").on("postgres_changes",{event:"*",schema:"public",table:i.ji.POMODORO_SESSIONS,filter:"shared=eq.true"},e=>{et(e)}).subscribe();G.current.set("leaderboard",e),G.current.set("shared",t),p(a=>new Map([...a,["leaderboard",e],["shared",t]]))},[d]),Z=(0,c.useCallback)(e=>{let{eventType:t,new:a,old:n}=e;switch(t){case"INSERT":"active"===a.status&&(y(a),ec({type:"session_started",message:'Pomodoro session "'.concat(a.title,'" started'),session:a,timestamp:new Date().toISOString()}));break;case"UPDATE":a.user_id===(null==d?void 0:d.id)&&ea(a,n)&&y("active"===a.status?a:null);break;case"DELETE":n.user_id===(null==d?void 0:d.id)&&"active"===n.status&&y(null)}},[d]),$=(0,c.useCallback)(e=>{let{eventType:t,new:a,old:n}=e;if(M(e=>{switch(t){case"INSERT":return[...e,a];case"UPDATE":return e.map(e=>e.id===a.id?a:e);case"DELETE":return e.filter(e=>e.id!==n.id);default:return e}}),"INSERT"===t){let e=new Date(new Date("".concat(a.date,"T").concat(a.time)).getTime()-6e4*(a.reminder_minutes||15));e>new Date&&setTimeout(()=>{ec({type:"meeting_reminder",message:'Meeting "'.concat(a.title,'" starting in ').concat(a.reminder_minutes||15," minutes"),meeting:a,timestamp:new Date().toISOString()})},e.getTime()-Date.now())}},[]),ee=(0,c.useCallback)(e=>{Q(t=>t.map(t=>t.user_id===e.new.user_id?(0,n._)({},t,e.new):t).sort((e,t)=>t.completed_minutes-e.completed_minutes))},[]),et=(0,c.useCallback)(e=>{let{eventType:t,new:a,old:n}=e;A(e=>{switch(t){case"INSERT":return[...e,a];case"UPDATE":return e.map(e=>e.id===a.id?a:e);case"DELETE":return e.filter(e=>e.id!==n.id);default:return e}})},[]),ea=(0,c.useCallback)((e,t)=>{let a="session_".concat(e.id),n=z.current.get(a)||0;return Date.now()-n>5e3?(z.current.set(a,Date.now()),!0):new Date(e.updated_at)>=new Date(t.updated_at)},[]),en=(0,c.useCallback)(e=>{k(t=>[...t,(0,s._)((0,n._)({},e),{id:"sync_".concat(Date.now(),"_").concat(Math.random()),timestamp:Date.now(),retries:0})])},[]),es=(0,c.useCallback)(async()=>{if(!D||0===v.length)return;let e=[...v];k([]);let t=[];for(let a of e)try{await er(a)}catch(e){console.error("Sync operation failed:",e,a),a.retries<3&&t.push((0,s._)((0,n._)({},a),{retries:a.retries+1}))}t.length>0&&k(e=>[...e,...t])},[D,v]),er=(0,c.useCallback)(async e=>{let{type:t,table:a,data:n,id:s}=e;switch(t){case"INSERT":let{error:r}=await i.OQ.from(a).insert(n);if(r)throw r;break;case"UPDATE":let{error:c}=await i.OQ.from(a).update(n).eq("id",s);if(c)throw c;break;case"DELETE":let{error:l}=await i.OQ.from(a).delete().eq("id",s);if(l)throw l}},[]),ec=(0,c.useCallback)(e=>{U(t=>[(0,s._)((0,n._)({},e),{id:"notif_".concat(Date.now(),"_").concat(Math.random()),read:!1}),...t.slice(0,49)])},[]),ei=(0,c.useCallback)(e=>{U(t=>t.map(t=>t.id===e?(0,s._)((0,n._)({},t),{read:!0}):t))},[]),el=(0,c.useCallback)(()=>{U([])},[]),eu=(0,c.useCallback)(async e=>{let t=G.current.get("presence");t&&await t.track((0,s._)((0,n._)({},_,e),{last_seen:new Date().toISOString()}))},[_]),eo=(0,c.useCallback)(async(e,t,a)=>{let n=G.current.get(e);n&&await n.send({type:"broadcast",event:t,payload:a})},[]),ed=(0,c.useCallback)(async(e,t)=>{switch(e.table){case i.ji.POMODORO_SESSIONS:"UPDATE"===e.type&&"active"===t.status&&y(t);break;case i.ji.USER_STATS:"UPDATE"===e.type&&R(e=>(0,n._)({},e,t))}if(D&&w)try{await er(e)}catch(t){console.error("Optimistic update failed, rolling back:",t),en(e)}else en(e)},[D,w,en,er]);(0,c.useEffect)(()=>{let e=()=>{O(!0),d&&F()},t=()=>{O(!1),f("disconnected")};return window.addEventListener("online",e),window.addEventListener("offline",t),()=>{window.removeEventListener("online",e),window.removeEventListener("offline",t)}},[d,F]),(0,c.useEffect)(()=>{d&&D&&"disconnected"===m?F():d||"disconnected"===m||J()},[d,D,m,F,J]),(0,c.useEffect)(()=>()=>{J()},[J]),(0,c.useEffect)(()=>{let e=setInterval(async()=>{w&&d&&(Date.now()-H.current>3e5||v.length>0)&&(await es(),H.current=Date.now())},6e4);return()=>clearInterval(e)},[w,d,v,es]);let ew={isConnected:w,connectionStatus:m,isOnline:D,realtimeSession:T,realtimeStats:C,realtimeMeetings:I,notifications:P,presenceData:_,onlineUsers:E,updatePresence:eu,sharedSessions:j,leaderboard:N,activityFeed:L,syncQueue:v,optimisticUpdate:ed,addToSyncQueue:en,addNotification:ec,markNotificationAsRead:ei,clearNotifications:el,connect:F,disconnect:J,broadcastMessage:eo,subscriptions:Array.from(S.keys())};return(0,r.jsx)(u.Provider,{value:ew,children:o})}}}]);