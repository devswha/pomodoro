<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>메인 페이지 - Stepper</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="main-style.css">
</head>
<body>
    <div class="iphone-container">

        <!-- User Header -->
        <div class="user-header">
            <div class="user-info">
                <div class="user-avatar">
                    <span class="user-initial" id="userInitial">U</span>
                </div>
                <div class="user-details">
                    <span class="user-name" id="userName">사용자</span>
                    <span class="user-welcome">안녕하세요! 👋</span>
                </div>
            </div>
            <button class="logout-btn" id="logoutBtn">
                <span>로그아웃</span>
            </button>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Statistics Cards -->
            <div class="stats-section">
                <div class="stat-card">
                    <div class="stat-header">
                        <h3 class="stat-title">학습 통계</h3>
                        <button class="stat-link" id="studyStatsBtn">자세히></button>
                    </div>
                    <div class="chart-container">
                        <div class="progress-chart" id="studyChart">
                            <svg width="120" height="120" viewBox="0 0 120 120">
                                <circle 
                                    cx="60" cy="60" r="45" 
                                    fill="none" 
                                    stroke="#F0F0F0" 
                                    stroke-width="10"
                                />
                                <!-- Purple segment -->
                                <circle 
                                    cx="60" cy="60" r="45" 
                                    fill="none" 
                                    stroke="#6B46C1" 
                                    stroke-width="10" 
                                    stroke-linecap="round"
                                    stroke-dasharray="141.37"
                                    stroke-dashoffset="70.68"
                                    transform="rotate(-90 60 60)"
                                    class="progress-segment progress-purple"
                                />
                                <!-- Orange segment -->
                                <circle 
                                    cx="60" cy="60" r="45" 
                                    fill="none" 
                                    stroke="#F97316" 
                                    stroke-width="10" 
                                    stroke-linecap="round"
                                    stroke-dasharray="94.25"
                                    stroke-dashoffset="0"
                                    transform="rotate(90 60 60)"
                                    class="progress-segment progress-orange"
                                />
                            </svg>
                            <div class="chart-center">
                                <div class="chart-value">75%</div>
                                <div class="chart-label">완료</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-header">
                        <h3 class="stat-title">월별 기록</h3>
                        <button class="stat-link" id="monthlyStatsBtn">자세히></button>
                    </div>
                    <div class="chart-placeholder">
                        <span class="placeholder-text"><달력 이미지></span>
                    </div>
                </div>
            </div>

            <!-- Action Cards -->
            <div class="actions-section">
                <div class="action-card" id="pomodoroStartCard">
                    <h3 class="action-title">뽀모도로 시작하기</h3>
                    <div class="action-description">집중력 향상을 위한 시간 관리 기법</div>
                </div>

                <div class="action-card" id="pomodoroRankingCard">
                    <h3 class="action-title">뽀모도로 랭킹</h3>
                    <div class="action-description">다른 사용자들과 비교해보세요</div>
                </div>

                <div class="action-card" id="eventCard">
                    <h3 class="action-title">진행중인 이벤트</h3>
                    <div class="action-description">특별한 혜택과 도전 과제</div>
                </div>
            </div>

            <!-- Today's Pomodoro -->
            <div class="today-section">
                <h2 class="today-title">진행중인 뽀모도로</h2>
                <div class="today-pomodoro">
                    <div class="pomodoro-time" id="pomodoroTime">09:30 AM</div>
                    <div class="pomodoro-actions">
                        <button class="pomodoro-btn break" id="breakBtn">중단</button>
                        <button class="pomodoro-btn focus" id="focusBtn">종료</button>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        // DOM이 완전히 로드된 후 MainDashboard 직접 실행
        document.addEventListener('DOMContentLoaded', function() {
            console.log('📄 DOM 로드 완료! 인라인 스크립트 시작...');
            
            // MainDashboard 클래스 정의
            class MainDashboard {
                constructor() {
                    console.log('🚀 인라인 MainDashboard 초기화 시작...');
                    this.currentUser = null;
                    this.pomodoroTimer = null;
                    this.isTimerRunning = false;
                    this.timeRemaining = 25 * 60;
                    this.init();
                }
                
                async init() {
                    try {
                        console.log('1️⃣ 사용자 데이터 로드 중...');
                        this.loadUserData();
                        
                        console.log('2️⃣ 이벤트 리스너 설정 중...');
                        this.setupEventListeners();
                        
                        console.log('3️⃣ UI 업데이트 중...');
                        this.updateUI();
                        
                        console.log('4️⃣ 타이머 시작 중...');
                        this.startTimeDisplay();
                        
                        console.log('🎉 MainDashboard 초기화 완료!');
                    } catch (error) {
                        console.error('💥 초기화 중 오류:', error);
                        alert('페이지 초기화에 실패했습니다. 새로고침해주세요.');
                    }
                }
                
                loadUserData() {
                    const urlParams = new URLSearchParams(window.location.search);
                    const userId = urlParams.get('user') || localStorage.getItem('currentUser') || '사용자';
                    
                    this.currentUser = {
                        id: userId,
                        studyStats: {
                            completed: 75,
                            totalSessions: 120,
                            monthlyHours: 45
                        }
                    };
                    
                    localStorage.setItem('currentUser', userId);
                    console.log('✅ 사용자 데이터 로드 완료:', this.currentUser.id);
                }
                
                setupEventListeners() {
                    console.log('🔗 이벤트 리스너 설정 시작...');
                    
                    const addSafeListener = (selector, event, handler, description) => {
                        const element = document.querySelector(selector);
                        if (element) {
                            element.addEventListener(event, handler);
                            console.log(`✅ ${description} 연결됨`);
                            return true;
                        } else {
                            console.warn(`⚠️ ${description} 요소를 찾을 수 없음: ${selector}`);
                            return false;
                        }
                    };
                    
                    let connected = 0;
                    connected += addSafeListener('#logoutBtn', 'click', () => this.handleLogout(), '로그아웃 버튼') ? 1 : 0;
                    connected += addSafeListener('#studyStatsBtn', 'click', () => this.handleStudyStats(), '학습 통계 버튼') ? 1 : 0;
                    connected += addSafeListener('#monthlyStatsBtn', 'click', () => this.handleMonthlyStats(), '월별 기록 버튼') ? 1 : 0;
                    connected += addSafeListener('#pomodoroStartCard', 'click', () => this.handlePomodoroStart(), '뽀모도로 시작 카드') ? 1 : 0;
                    connected += addSafeListener('#pomodoroRankingCard', 'click', () => this.handlePomodoroRanking(), '뽀모도로 랭킹 카드') ? 1 : 0;
                    connected += addSafeListener('#eventCard', 'click', () => this.handleEvent(), '이벤트 카드') ? 1 : 0;
                    connected += addSafeListener('#breakBtn', 'click', () => this.handleBreak(), '중단 버튼') ? 1 : 0;
                    connected += addSafeListener('#focusBtn', 'click', () => this.handleFocus(), '종료 버튼') ? 1 : 0;
                    
                    console.log(`📊 총 ${connected}/8개 버튼 연결 완료`);
                    
                    if (connected === 0) {
                        throw new Error('모든 버튼 연결에 실패했습니다.');
                    }
                }
                
                updateUI() {
                    const userName = document.querySelector('#userName');
                    const userInitial = document.querySelector('#userInitial');
                    
                    if (userName && userInitial && this.currentUser) {
                        userName.textContent = this.currentUser.id;
                        userInitial.textContent = this.currentUser.id.charAt(0).toUpperCase();
                        
                        const colors = [
                            'linear-gradient(135deg, #007AFF, #5856D6)',
                            'linear-gradient(135deg, #34C759, #32D74B)', 
                            'linear-gradient(135deg, #FF9500, #FF6B00)',
                            'linear-gradient(135deg, #FF3B30, #D70015)',
                            'linear-gradient(135deg, #5856D6, #AF52DE)',
                            'linear-gradient(135deg, #00C7BE, #5856D6)'
                        ];
                        
                        const colorIndex = this.currentUser.id.length % colors.length;
                        const avatar = userInitial.parentElement;
                        if (avatar) {
                            avatar.style.background = colors[colorIndex];
                        }
                        
                        console.log('✅ 사용자 UI 업데이트 완료');
                    }
                }
                
                startTimeDisplay() {
                    const pomodoroTime = document.querySelector('#pomodoroTime');
                    if (!pomodoroTime) return;
                    
                    const updateTime = () => {
                        const now = new Date();
                        const timeString = now.toLocaleTimeString('ko-KR', {
                            hour: '2-digit',
                            minute: '2-digit',
                            hour12: true
                        });
                        pomodoroTime.textContent = timeString;
                    };
                    
                    updateTime();
                    setInterval(updateTime, 1000);
                    console.log('⏰ 시계 표시 시작');
                }
                
                handleLogout() {
                    console.log('🚪 로그아웃 클릭됨');
                    const confirmed = confirm('로그아웃하시겠습니까?');
                    if (confirmed) {
                        localStorage.removeItem('currentUser');
                        localStorage.removeItem('userStats');
                        this.showToast('로그아웃되었습니다', 'info');
                        setTimeout(() => {
                            window.location.href = 'index.html';
                        }, 1000);
                    }
                }
                
                handleStudyStats() {
                    console.log('📊 학습 통계 클릭됨');
                    this.showToast('학습 통계 상세 페이지로 이동합니다');
                    setTimeout(() => {
                        window.location.href = `mypage.html?user=${encodeURIComponent(this.currentUser.id)}`;
                    }, 500);
                }
                
                handleMonthlyStats() {
                    console.log('📅 월별 기록 클릭됨');
                    this.showToast('월별 기록 페이지로 이동합니다');
                    setTimeout(() => {
                        window.location.href = `monthly.html?user=${encodeURIComponent(this.currentUser.id)}`;
                    }, 500);
                }
                
                handlePomodoroStart() {
                    console.log('🍅 뽀모도로 시작 클릭됨');
                    this.showToast('뽀모도로 시작 페이지로 이동합니다');
                    setTimeout(() => {
                        window.location.href = `pomodoro-start.html?user=${encodeURIComponent(this.currentUser.id)}`;
                    }, 500);
                }
                
                handlePomodoroRanking() {
                    console.log('🏆 뽀모도로 랭킹 클릭됨');
                    this.showToast('뽀모도로 랭킹 페이지로 이동합니다');
                    setTimeout(() => {
                        window.location.href = `pomodoro-ranking.html?user=${encodeURIComponent(this.currentUser.id)}`;
                    }, 500);
                }
                
                handleEvent() {
                    console.log('🎉 이벤트 클릭됨');
                    this.showToast('진행중인 이벤트 페이지로 이동합니다');
                }
                
                handleBreak() {
                    console.log('⏸️ 중단 버튼 클릭됨');
                    this.showToast('중단 기능');
                }
                
                handleFocus() {
                    console.log('⏹️ 종료 버튼 클릭됨');
                    this.showToast('종료 기능');
                }
                
                showToast(message, type = 'info', duration = 2000) {
                    console.log(`💬 토스트: ${message}`);
                    
                    const toast = document.createElement('div');
                    toast.textContent = message;
                    toast.style.cssText = `
                        position: fixed;
                        top: 120px;
                        left: 50%;
                        transform: translateX(-50%);
                        background: ${type === 'success' ? '#34C759' : type === 'error' ? '#FF3B30' : '#007AFF'};
                        color: white;
                        padding: 12px 20px;
                        border-radius: 20px;
                        font-size: 14px;
                        font-weight: 500;
                        z-index: 1000;
                        opacity: 0;
                        transition: all 0.3s ease;
                        max-width: 280px;
                        text-align: center;
                        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                    `;
                    
                    document.body.appendChild(toast);
                    
                    setTimeout(() => {
                        toast.style.opacity = '1';
                        toast.style.transform = 'translateX(-50%) translateY(10px)';
                    }, 100);
                    
                    setTimeout(() => {
                        toast.style.opacity = '0';
                        setTimeout(() => {
                            if (document.body.contains(toast)) {
                                document.body.removeChild(toast);
                            }
                        }, 300);
                    }, duration);
                }
            }
            
            // MainDashboard 초기화
            try {
                const dashboard = new MainDashboard();
                window.dashboard = dashboard;
                console.log('🌍 Global dashboard 변수 설정 완료');
            } catch (error) {
                console.error('💥 MainDashboard 생성 실패:', error);
                alert('페이지 로드에 실패했습니다. 새로고침해주세요.');
            }
        });
    </script>
</body>
</html>