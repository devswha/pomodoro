class PomodoroRanking {
    constructor() {
        console.log('üèÜ PomodoroRanking Ï¥àÍ∏∞Ìôî ÏãúÏûë...');
        
        this.currentUser = null;
        this.currentMonth = 12; // December
        this.currentYear = 2024;
        this.rankingData = [];
        
        this.init();
    }
    
    async init() {
        try {
            console.log('1Ô∏è‚É£ ÏÇ¨Ïö©Ïûê Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ï§ë...');
            this.loadUserData();
            
            console.log('2Ô∏è‚É£ Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà ÏÑ§Ï†ï Ï§ë...');
            this.setupEventListeners();
            
            console.log('3Ô∏è‚É£ Îû≠ÌÇπ Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ï§ë...');
            this.loadRankingData();
            
            console.log('4Ô∏è‚É£ UI ÏóÖÎç∞Ïù¥Ìä∏ Ï§ë...');
            this.updateUI();
            
            console.log('üéâ PomodoroRanking Ï¥àÍ∏∞Ìôî ÏôÑÎ£å!');
        } catch (error) {
            console.error('üí• Ï¥àÍ∏∞Ìôî Ï§ë Ïò§Î•ò:', error);
            alert('ÌéòÏù¥ÏßÄ Ï¥àÍ∏∞ÌôîÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§. ÏÉàÎ°úÍ≥†Ïπ®Ìï¥Ï£ºÏÑ∏Ïöî.');
        }
    }
    
    loadUserData() {
        const urlParams = new URLSearchParams(window.location.search);
        const userId = urlParams.get('user') || localStorage.getItem('currentUser') || 'ÏÇ¨Ïö©Ïûê';
        
        this.currentUser = {
            id: userId
        };
        
        console.log('‚úÖ ÏÇ¨Ïö©Ïûê Îç∞Ïù¥ÌÑ∞ Î°úÎìú ÏôÑÎ£å:', this.currentUser.id);
    }
    
    setupEventListeners() {
        console.log('üîó Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà ÏÑ§Ï†ï ÏãúÏûë...');
        
        const addSafeListener = (selector, event, handler, description) => {
            const element = document.querySelector(selector);
            if (element) {
                element.addEventListener(event, handler);
                console.log(`‚úÖ ${description} Ïó∞Í≤∞Îê®`);
                return true;
            } else {
                console.warn(`‚ö†Ô∏è ${description} ÏöîÏÜåÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏùå: ${selector}`);
                return false;
            }
        };
        
        let connected = 0;
        
        // Navigation
        connected += addSafeListener('#backBtn', 'click', () => this.handleBack(), 'Îí§Î°úÍ∞ÄÍ∏∞ Î≤ÑÌäº') ? 1 : 0;
        connected += addSafeListener('#prevMonthBtn', 'click', () => this.handlePrevMonth(), 'Ïù¥Ï†Ñ Îã¨ Î≤ÑÌäº') ? 1 : 0;
        connected += addSafeListener('#nextMonthBtn', 'click', () => this.handleNextMonth(), 'Îã§Ïùå Îã¨ Î≤ÑÌäº') ? 1 : 0;
        connected += addSafeListener('#monthBtn', 'click', () => this.showMonthPicker(), 'Ïõî ÏÑ†ÌÉù Î≤ÑÌäº') ? 1 : 0;
        
        // Modal controls
        connected += addSafeListener('#monthCancelBtn', 'click', () => this.hideMonthPicker(), 'Ïõî ÏÑ†ÌÉù Ï∑®ÏÜå Î≤ÑÌäº') ? 1 : 0;
        connected += addSafeListener('#monthConfirmBtn', 'click', () => this.confirmMonthSelection(), 'Ïõî ÏÑ†ÌÉù ÌôïÏù∏ Î≤ÑÌäº') ? 1 : 0;
        
        // Month options
        const monthOptions = document.querySelectorAll('.month-option');
        monthOptions.forEach(option => {
            option.addEventListener('click', (e) => this.selectMonth(e));
            connected++;
        });
        
        // Modal overlay click to close
        const monthModal = document.querySelector('#monthModal');
        if (monthModal) {
            monthModal.addEventListener('click', (e) => {
                if (e.target === monthModal) {
                    this.hideMonthPicker();
                }
            });
            connected++;
        }
        
        console.log(`üìä Ï¥ù ${connected}Í∞úÏùò Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑàÍ∞Ä Ïó∞Í≤∞ÎêòÏóàÏäµÎãàÎã§.`);
    }
    
    loadRankingData() {
        // Generate mock ranking data for the current month
        this.rankingData = [
            {
                rank: 1,
                name: 'ÌôçÍ∏∏Îèô',
                medal: 'ü•à',
                score: 2400,
                achievement: '2000Ï†ê Ïù¥ÏÉÅ',
                isCurrentUser: false
            },
            {
                rank: 2,
                name: 'ÍπÄÏ†ïÏßÄ',
                medal: 'üèÖ',
                score: 1700,
                achievement: '500Ï†ê Ïù¥ÏÉÅ',
                isCurrentUser: false
            },
            {
                rank: 3,
                name: 'Ïû†ÏàúÏù¥',
                medal: '‚ù§Ô∏è',
                score: 900,
                achievement: '',
                isCurrentUser: false
            },
            {
                rank: 4,
                name: 'Ìôç ÎèÑ',
                medal: 'ü•â',
                score: 300,
                achievement: '',
                isCurrentUser: false
            },
            {
                rank: 5,
                name: 'Ïù¥Í¥ëÏàò',
                medal: 'üåà',
                score: 0,
                achievement: '',
                isCurrentUser: false
            }
        ];
        
        // Check if current user is in ranking
        const userRank = this.rankingData.find(user => user.name === this.currentUser.id);
        if (!userRank && this.currentUser.id !== 'ÏÇ¨Ïö©Ïûê') {
            // Add current user to ranking if not present
            this.rankingData.push({
                rank: this.rankingData.length + 1,
                name: this.currentUser.id,
                medal: 'üÜï',
                score: Math.floor(Math.random() * 500),
                achievement: 'ÏÉàÎ°úÏö¥ ÏÇ¨Ïö©Ïûê',
                isCurrentUser: true
            });
        }
        
        console.log('‚úÖ Îû≠ÌÇπ Îç∞Ïù¥ÌÑ∞ Î°úÎìú ÏôÑÎ£å:', this.rankingData.length, 'Î™Ö');
    }
    
    updateUI() {
        console.log('üé® UI ÏóÖÎç∞Ïù¥Ìä∏ Ï§ë...');
        
        // Update month display
        const monthText = document.querySelector('#monthText');
        if (monthText) {
            monthText.textContent = `${this.currentMonth}Ïõî`;
        }
        
        // Update ranking list (already in HTML, but could be dynamic)
        this.updateRankingList();
        
        // Update month picker selection
        this.updateMonthPickerSelection();
        
        console.log('‚úÖ UI ÏóÖÎç∞Ïù¥Ìä∏ ÏôÑÎ£å');
    }
    
    updateRankingList() {
        const rankingSection = document.querySelector('.ranking-section');
        if (!rankingSection) return;
        
        // Clear existing items
        rankingSection.innerHTML = '';
        
        // Generate ranking items
        this.rankingData.forEach((user, index) => {
            const rankItem = document.createElement('div');
            rankItem.className = `ranking-item rank-${index + 1}`;
            
            if (user.isCurrentUser) {
                rankItem.classList.add('current-user');
                rankItem.style.background = 'linear-gradient(135deg, #E6F3FF, #FFFFFF)';
                rankItem.style.borderLeft = '4px solid #007AFF';
            }
            
            rankItem.innerHTML = `
                <div class="rank-info">
                    <div class="user-details">
                        <span class="user-name">${user.name}</span>
                        <span class="user-medal">${user.medal}</span>
                    </div>
                    <div class="user-meta">
                        <span class="user-achievement">${user.achievement}</span>
                    </div>
                </div>
                <div class="user-score">${user.score}</div>
            `;
            
            // Add click event
            rankItem.addEventListener('click', () => this.handleUserClick(user));
            
            rankingSection.appendChild(rankItem);
        });
        
        console.log('‚úÖ Îû≠ÌÇπ Î¶¨Ïä§Ìä∏ ÏóÖÎç∞Ïù¥Ìä∏ ÏôÑÎ£å');
    }
    
    updateMonthPickerSelection() {
        const monthOptions = document.querySelectorAll('.month-option');
        monthOptions.forEach(option => {
            const month = parseInt(option.dataset.month);
            if (month === this.currentMonth) {
                option.classList.add('selected');
            } else {
                option.classList.remove('selected');
            }
        });
    }
    
    // Event handlers
    handleBack() {
        console.log('üîô Îí§Î°úÍ∞ÄÍ∏∞ ÌÅ¥Î¶≠Îê®');
        
        if (this.currentUser && this.currentUser.id) {
            window.location.href = `main.html?user=${encodeURIComponent(this.currentUser.id)}`;
        } else {
            window.location.href = 'main.html';
        }
    }
    
    handlePrevMonth() {
        console.log('‚¨ÖÔ∏è Ïù¥Ï†Ñ Îã¨ ÌÅ¥Î¶≠Îê®');
        
        this.currentMonth--;
        if (this.currentMonth < 1) {
            this.currentMonth = 12;
            this.currentYear--;
        }
        
        this.showToast(`${this.currentMonth}ÏõîÎ°ú Ïù¥Îèô`);
        this.loadRankingData();
        this.updateUI();
    }
    
    handleNextMonth() {
        console.log('‚û°Ô∏è Îã§Ïùå Îã¨ ÌÅ¥Î¶≠Îê®');
        
        this.currentMonth++;
        if (this.currentMonth > 12) {
            this.currentMonth = 1;
            this.currentYear++;
        }
        
        this.showToast(`${this.currentMonth}ÏõîÎ°ú Ïù¥Îèô`);
        this.loadRankingData();
        this.updateUI();
    }
    
    showMonthPicker() {
        console.log('üìÖ Ïõî ÏÑ†ÌÉùÍ∏∞ ÌëúÏãú');
        
        const monthModal = document.querySelector('#monthModal');
        if (monthModal) {
            monthModal.classList.remove('hidden');
        }
    }
    
    hideMonthPicker() {
        console.log('üìÖ Ïõî ÏÑ†ÌÉùÍ∏∞ Ïà®ÍπÄ');
        
        const monthModal = document.querySelector('#monthModal');
        if (monthModal) {
            monthModal.classList.add('hidden');
        }
    }
    
    selectMonth(e) {
        const month = parseInt(e.target.dataset.month);
        console.log(`üìÖ ${month}Ïõî ÏÑ†ÌÉùÎê®`);
        
        // Update selection visually
        document.querySelectorAll('.month-option').forEach(option => {
            option.classList.remove('selected');
        });
        e.target.classList.add('selected');
        
        // Store temporarily (will be applied on confirm)
        this.tempSelectedMonth = month;
    }
    
    confirmMonthSelection() {
        console.log('‚úÖ Ïõî ÏÑ†ÌÉù ÌôïÏù∏Îê®');
        
        if (this.tempSelectedMonth) {
            this.currentMonth = this.tempSelectedMonth;
            this.showToast(`${this.currentMonth}Ïõî Îû≠ÌÇπÏúºÎ°ú Î≥ÄÍ≤Ω`);
            this.loadRankingData();
            this.updateUI();
        }
        
        this.hideMonthPicker();
    }
    
    handleUserClick(user) {
        console.log('üë§ ÏÇ¨Ïö©Ïûê ÌÅ¥Î¶≠Îê®:', user.name);
        
        if (user.isCurrentUser) {
            this.showToast('ÎÇ¥ Îû≠ÌÇπ Ï†ïÎ≥¥ÏûÖÎãàÎã§', 'info');
        } else {
            this.showToast(`${user.name}ÎãòÏùò ÏÉÅÏÑ∏ Ï†ïÎ≥¥`, 'info');
        }
    }
    
    // Utility functions
    showToast(message, type = 'info', duration = 2000) {
        console.log(`üí¨ ÌÜ†Ïä§Ìä∏: ${message}`);
        
        const toast = document.createElement('div');
        toast.textContent = message;
        toast.style.cssText = `
            position: fixed;
            top: 120px;
            left: 50%;
            transform: translateX(-50%);
            background: ${type === 'success' ? '#34C759' : type === 'error' ? '#FF3B30' : '#007AFF'};
            color: white;
            padding: 12px 20px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            z-index: 1000;
            opacity: 0;
            transition: all 0.3s ease;
            max-width: 280px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        `;
        
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.style.opacity = '1';
            toast.style.transform = 'translateX(-50%) translateY(10px)';
        }, 100);
        
        setTimeout(() => {
            toast.style.opacity = '0';
            toast.style.transform = 'translateX(-50%) translateY(-10px)';
            setTimeout(() => {
                if (document.body.contains(toast)) {
                    document.body.removeChild(toast);
                }
            }, 300);
        }, duration);
    }
    
    // Data generation methods
    generateRandomScore() {
        return Math.floor(Math.random() * 3000);
    }
    
    getMedalForRank(rank) {
        const medals = ['ü•á', 'ü•à', 'ü•â', 'üèÖ', '‚≠ê', 'üíé', 'üî•', '‚ù§Ô∏è', 'üåà', 'üÜï'];
        return medals[rank - 1] || 'üèÉ‚Äç‚ôÇÔ∏è';
    }
    
    getAchievementForScore(score) {
        if (score >= 2000) return '2000Ï†ê Ïù¥ÏÉÅ';
        if (score >= 1000) return '1000Ï†ê Ïù¥ÏÉÅ';
        if (score >= 500) return '500Ï†ê Ïù¥ÏÉÅ';
        return '';
    }
    
    // Export/Share functionality
    exportRanking() {
        const data = {
            month: `${this.currentYear}ÎÖÑ ${this.currentMonth}Ïõî`,
            ranking: this.rankingData,
            exportedAt: new Date().toISOString()
        };
        
        console.log('üì§ Îû≠ÌÇπ Îç∞Ïù¥ÌÑ∞ ÎÇ¥Î≥¥ÎÇ¥Í∏∞:', data);
        this.showToast('Îû≠ÌÇπ Îç∞Ïù¥ÌÑ∞Í∞Ä ÎÇ¥Î≥¥ÎÇ¥Ï°åÏäµÎãàÎã§', 'success');
        
        return data;
    }
}

// Initialize ranking page when DOM is loaded
document.addEventListener('DOMContentLoaded', () => {
    console.log('üìÑ DOM Î°úÎìú ÏôÑÎ£å! PomodoroRanking Ï¥àÍ∏∞Ìôî ÏãúÏûë...');
    
    try {
        const ranking = new PomodoroRanking();
        
        // Global access for debugging
        window.pomodoroRanking = ranking;
        
        console.log('üåç Global pomodoroRanking Î≥ÄÏàò ÏÑ§Ï†ï ÏôÑÎ£å');
    } catch (error) {
        console.error('üí• PomodoroRanking ÏÉùÏÑ± Ïã§Ìå®:', error);
        alert('Îû≠ÌÇπ ÌéòÏù¥ÏßÄ Î°úÎìúÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§. ÏÉàÎ°úÍ≥†Ïπ®Ìï¥Ï£ºÏÑ∏Ïöî.');
    }
});

// Handle page visibility changes
document.addEventListener('visibilitychange', () => {
    if (document.hidden) {
        console.log('Îû≠ÌÇπ ÌéòÏù¥ÏßÄÍ∞Ä Ïà®Í≤®Ïßê');
    } else {
        console.log('Îû≠ÌÇπ ÌéòÏù¥ÏßÄÍ∞Ä Îã§Ïãú ÌëúÏãúÎê®');
    }
});

// Handle orientation changes
window.addEventListener('orientationchange', () => {
    setTimeout(() => {
        window.scrollTo(0, 0);
    }, 100);
});

// Keyboard shortcuts
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        // Close modals or go back
        const monthModal = document.querySelector('#monthModal');
        if (monthModal && !monthModal.classList.contains('hidden')) {
            window.pomodoroRanking?.hideMonthPicker();
        } else {
            window.pomodoroRanking?.handleBack();
        }
    } else if (e.key === 'ArrowLeft') {
        // Previous month
        window.pomodoroRanking?.handlePrevMonth();
    } else if (e.key === 'ArrowRight') {
        // Next month
        window.pomodoroRanking?.handleNextMonth();
    }
});

// Handle back button navigation
window.addEventListener('popstate', (e) => {
    console.log('Îí§Î°úÍ∞ÄÍ∏∞ Í∞êÏßÄ - Î©îÏù∏ ÌéòÏù¥ÏßÄÎ°ú Ïù¥Îèô');
    // Handle navigation state
});